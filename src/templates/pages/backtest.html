{% extends 'base.html' %}
{% load static %}

{% block title %}Backtest Results - FKS Trading Platform{% endblock %}

{% block extra_css %}
<!-- Plotly.js for advanced charting -->
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="bi bi-hourglass-split"></i>
            Backtest Results
        </h2>
        <p class="text-muted">Historical performance testing and strategy optimization</p>
    </div>
</div>

<!-- New Backtest Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-play-circle"></i>
                    Run New Backtest
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="backtestForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Strategy</label>
                            <select class="form-select" name="strategy" required>
                                <option value="">Select Strategy</option>
                                <option value="rsi_divergence">RSI Divergence</option>
                                <option value="macd_crossover">MACD Crossover</option>
                                <option value="bollinger_bands">Bollinger Bands</option>
                                <option value="breakout">Breakout</option>
                                <option value="mean_reversion">Mean Reversion</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Symbol</label>
                            <select class="form-select" name="symbol" required>
                                <option value="BTCUSDT">BTCUSDT</option>
                                <option value="ETHUSDT">ETHUSDT</option>
                                <option value="SOLUSDT">SOLUSDT</option>
                                <option value="BNBUSDT">BNBUSDT</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Initial Capital</label>
                            <input type="number" class="form-control" name="initial_capital" value="10000" step="100" required>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-play-fill"></i> Run
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Backtest Results Summary -->
{% if backtest_result %}
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-start-success">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total Return</h6>
                <h3 class="mb-0 {% if backtest_result.total_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ backtest_result.total_return|default:"15.3"|floatformat:2 }}%
                </h3>
                <small class="text-muted">Net profit/loss</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-start-primary">
            <div class="card-body">
                <h6 class="text-muted mb-2">Win Rate</h6>
                <h3 class="mb-0">{{ backtest_result.win_rate|default:"68.5"|floatformat:1 }}%</h3>
                <small class="text-muted">{{ backtest_result.winning_trades|default:"137" }}/{{ backtest_result.total_trades|default:"200" }} trades</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-start-warning">
            <div class="card-body">
                <h6 class="text-muted mb-2">Sharpe Ratio</h6>
                <h3 class="mb-0">{{ backtest_result.sharpe_ratio|default:"1.85"|floatformat:2 }}</h3>
                <small class="text-muted">Risk-adjusted return</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-start-danger">
            <div class="card-body">
                <h6 class="text-muted mb-2">Max Drawdown</h6>
                <h3 class="mb-0 text-danger">-{{ backtest_result.max_drawdown|default:"12.5"|floatformat:2 }}%</h3>
                <small class="text-muted">Largest peak-to-trough</small>
            </div>
        </div>
    </div>
</div>

<!-- Performance Charts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i>
                    Equity Curve
                </h5>
            </div>
            <div class="card-body">
                <div id="equityCurve" style="width:100%; height:400px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i>
                    Trade Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="tradeDistribution" style="width:100%; height:300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i>
                    Win/Loss Ratio
                </h5>
            </div>
            <div class="card-body">
                <div id="winLossChart" style="width:100%; height:300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Metrics -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i>
                    Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Total Trades</strong></td>
                            <td class="text-end">{{ backtest_result.total_trades|default:"200" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Winning Trades</strong></td>
                            <td class="text-end text-success">{{ backtest_result.winning_trades|default:"137" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Losing Trades</strong></td>
                            <td class="text-end text-danger">{{ backtest_result.losing_trades|default:"63" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Average Win</strong></td>
                            <td class="text-end">${{ backtest_result.avg_win|default:"345.20"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Average Loss</strong></td>
                            <td class="text-end">${{ backtest_result.avg_loss|default:"142.50"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Profit Factor</strong></td>
                            <td class="text-end">{{ backtest_result.profit_factor|default:"2.42"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Recovery Factor</strong></td>
                            <td class="text-end">{{ backtest_result.recovery_factor|default:"4.8"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Expectancy</strong></td>
                            <td class="text-end">${{ backtest_result.expectancy|default:"185.50"|floatformat:2 }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i>
                    Strategy Parameters
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Strategy</strong></td>
                            <td class="text-end">{{ backtest_result.strategy_name|default:"RSI Divergence" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Symbol</strong></td>
                            <td class="text-end">{{ backtest_result.symbol|default:"BTCUSDT" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Timeframe</strong></td>
                            <td class="text-end">{{ backtest_result.timeframe|default:"1h" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Initial Capital</strong></td>
                            <td class="text-end">${{ backtest_result.initial_capital|default:"10,000.00"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Final Equity</strong></td>
                            <td class="text-end">${{ backtest_result.final_equity|default:"11,530.00"|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Commission</strong></td>
                            <td class="text-end">{{ backtest_result.commission|default:"0.1"|floatformat:2 }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Slippage</strong></td>
                            <td class="text-end">{{ backtest_result.slippage|default:"0.05"|floatformat:2 }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Test Duration</strong></td>
                            <td class="text-end">{{ backtest_result.duration|default:"90 days" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Trade Log -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i>
                    Trade Log
                </h5>
                <button class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in backtest_result.trades|default:sample_trades %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ trade.date }}</td>
                                <td>
                                    <span class="badge bg-{{ trade.type_color }}">{{ trade.type }}</span>
                                </td>
                                <td>${{ trade.entry|floatformat:2 }}</td>
                                <td>${{ trade.exit|floatformat:2 }}</td>
                                <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ trade.pnl|floatformat:2 }}
                                </td>
                                <td class="{% if trade.pnl_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ trade.pnl_percent|floatformat:2 }}%
                                </td>
                                <td>{{ trade.duration }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    No trade history available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>No backtest results yet.</strong> Configure and run a backtest above to see detailed performance analysis.
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
{% if backtest_result %}
// Equity Curve
var equityData = [{
    x: {{ backtest_result.equity_dates|default:"['2024-01-01', '2024-02-01', '2024-03-01', '2024-04-01']"|safe }},
    y: {{ backtest_result.equity_values|default:"[10000, 10850, 10650, 11530]"|safe }},
    type: 'scatter',
    mode: 'lines',
    name: 'Equity',
    line: {color: '#198754', width: 2}
}];

var equityLayout = {
    title: 'Portfolio Equity Over Time',
    xaxis: {title: 'Date'},
    yaxis: {title: 'Equity ($)'},
    hovermode: 'closest'
};

Plotly.newPlot('equityCurve', equityData, equityLayout, {responsive: true});

// Trade Distribution
var tradeDistData = [{
    x: {{ backtest_result.trade_pnl|default:"[150, -75, 200, -50, 180, 120, -90, 250, -40, 175]"|safe }},
    type: 'histogram',
    marker: {
        color: 'rgba(13, 110, 253, 0.7)',
    }
}];

var tradeDistLayout = {
    title: 'P&L Distribution',
    xaxis: {title: 'Profit/Loss ($)'},
    yaxis: {title: 'Frequency'},
};

Plotly.newPlot('tradeDistribution', tradeDistData, tradeDistLayout, {responsive: true});

// Win/Loss Chart
var winLossData = [{
    values: [{{ backtest_result.winning_trades|default:"137" }}, {{ backtest_result.losing_trades|default:"63" }}],
    labels: ['Winning Trades', 'Losing Trades'],
    type: 'pie',
    marker: {
        colors: ['#198754', '#dc3545']
    }
}];

var winLossLayout = {
    title: 'Win/Loss Distribution',
};

Plotly.newPlot('winLossChart', winLossData, winLossLayout, {responsive: true});
{% endif %}

// Form submission
document.getElementById('backtestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const submitBtn = this.querySelector('[type="submit"]');
    window.fksTrading.setButtonLoading(submitBtn, true);
    
    // TODO: Submit form via AJAX and update results
    setTimeout(function() {
        window.fksTrading.showToast('Backtest started! Results will appear below.', 'info');
        window.fksTrading.setButtonLoading(submitBtn, false);
    }, 2000);
});
</script>
{% endblock %}
